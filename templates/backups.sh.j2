#!/bin/bash
# Backup Linux Servers Script
#
# Reads servers list and runs rdiff-backup for each server.
# Removes backups after 1-year old
#
# This script should be called by Cron hourly.
#
# Requirements:
# rdiff-backup must be installed on client and server
# ssh key authentication must be setup for root on clients

echo "Start backups"
date

for i in `cat /opt/rdiff-backups/serverlist`;
do
   rdiff-backup --print-statistics --exclude /tmp'*' --exclude /var/tmp/'*' --exclude /mnt --exclude /proc --exclude /sys --exclude /var/lib/lxcfs root@$i::/ /opt/rdiff-backups/backups/$i/ 2>&1 | grep -v "^UpdateError .* Updated mirror temp file.* does not match source"
   rdiff-backup --remove-older-than 1Y /opt/rdiff-backups/backups/$i/
done

date
echo "End backups"
